<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="a Comparison between Standard NN and BNN by cyda BNN, Bayesian Neural Network, is a stochastic artificial neural network trained using Bayesian inference. Related LibrariesImplement BNN mainly based o">
<meta property="og:type" content="article">
<meta property="og:title" content="BNN">
<meta property="og:url" content="https://xli1110.github.io/2021/11/30/BNN/index.html">
<meta property="og:site_name" content="xli">
<meta property="og:description" content="a Comparison between Standard NN and BNN by cyda BNN, Bayesian Neural Network, is a stochastic artificial neural network trained using Bayesian inference. Related LibrariesImplement BNN mainly based o">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xli1110.github.io/2021/11/30/BNN/BNN_by_cyda.png">
<meta property="article:published_time" content="2021-11-30T12:48:19.000Z">
<meta property="article:modified_time" content="2021-11-30T13:49:17.603Z">
<meta property="article:author" content="xli">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xli1110.github.io/2021/11/30/BNN/BNN_by_cyda.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>BNN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" "Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/Python/">Python</a></li>
         
          <li><a href="/Plant/">Plant</a></li>
         
          <li><a href="/Others/">Others</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post " href="/2021/12/10/BeautifulSoup/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post " href="/2021/11/17/LGBM/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top " href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://xli1110.github.io/2021/11/30/BNN/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://xli1110.github.io/2021/11/30/BNN/&text=BNN"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://xli1110.github.io/2021/11/30/BNN/&is_video=false&description=BNN"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BNN&body=Check out this article: https://xli1110.github.io/2021/11/30/BNN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://xli1110.github.io/2021/11/30/BNN/&name=BNN&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://xli1110.github.io/2021/11/30/BNN/&t=BNN"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Related-Libraries"><span class="toc-number">1.</span> <span class="toc-text">Related Libraries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Load-Data-Set"><span class="toc-number">2.</span> <span class="toc-text">Load Data Set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Define-and-Construct-the-Network"><span class="toc-number">3.</span> <span class="toc-text">Define and Construct the Network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Customize-Stochastic-Variational-Inference-Object-SVI"><span class="toc-number">4.</span> <span class="toc-text">Customize Stochastic Variational Inference Object (SVI)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Train-and-Predict"><span class="toc-number">5.</span> <span class="toc-text">Train and Predict</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Evaluation"><span class="toc-number">6.</span> <span class="toc-text">Evaluation</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        BNN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">xli</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-30T12:48:19.000Z" itemprop="datePublished">2021-11-30</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Python/" rel="tag">Python</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="/2021/11/30/BNN/BNN_by_cyda.png"><br>a Comparison between Standard NN and BNN by <a target="_blank" rel="noopener" href="https://blog.cyda.hk/">cyda</a></p>
<p><code>BNN</code>, Bayesian Neural Network, is a stochastic artificial neural network trained using Bayesian inference.</p>
<h2 id="Related-Libraries"><a href="#Related-Libraries" class="headerlink" title="Related Libraries"></a>Related Libraries</h2><p>Implement BNN mainly based on <code>pytorch</code> and <code>pyro</code>.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pytorch.org/">pytorch</a><br>An open source machine learning framework that accelerates the path from research prototyping to production deployment.</li>
<li><a target="_blank" rel="noopener" href="https://pyro.ai/">pyro</a><br>Pyro is a universal probabilistic programming language (PPL) written in Python and supported by PyTorch on the backend. Pyro enables flexible and expressive deep probabilistic modeling, unifying the best of modern deep learning and Bayesian modeling.</li>
</ul>
<h2 id="Load-Data-Set"><a href="#Load-Data-Set" class="headerlink" title="Load Data Set"></a>Load Data Set</h2><p>Load MNIST data from a local folder <code>DATA_PATH</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets, transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"></span><br><span class="line">train_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(</span><br><span class="line">        DATA_PATH,</span><br><span class="line">        train=<span class="literal">True</span>,</span><br><span class="line">        download=<span class="literal">True</span>,</span><br><span class="line">        transform=transforms.Compose([transforms.ToTensor(), ])</span><br><span class="line">    ),</span><br><span class="line">    batch_size=<span class="number">128</span>,</span><br><span class="line">    shuffle=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line">test_loader = torch.utils.data.DataLoader(</span><br><span class="line">    datasets.MNIST(</span><br><span class="line">        DATA_PATH,</span><br><span class="line">        train=<span class="literal">False</span>,</span><br><span class="line">        transform=transforms.Compose([transforms.ToTensor(), ])</span><br><span class="line">    ),</span><br><span class="line">    batch_size=<span class="number">128</span>,</span><br><span class="line">    shuffle=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Define-and-Construct-the-Network"><a href="#Define-and-Construct-the-Network" class="headerlink" title="Define and Construct the Network"></a>Define and Construct the Network</h2><p>We define a network with 2 layers, and the activation function as <code>ReLU</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NN</span>(<span class="params">nn.Module</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Define the Network</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, input_size, hidden_size, output_size</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(NN, self).__init__()</span><br><span class="line">        self.fc1 = nn.Linear(input_size, hidden_size)</span><br><span class="line">        self.fc2 = nn.Linear(hidden_size, output_size)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span>(<span class="params">self, x</span>):</span></span><br><span class="line">        x = self.fc1(x)</span><br><span class="line">        x = F.relu(x)</span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Construction</span></span><br><span class="line">net = NN(<span class="number">28</span> * <span class="number">28</span>, <span class="number">1024</span>, <span class="number">10</span>)  <span class="comment"># network</span></span><br><span class="line">log_softmax = nn.LogSoftmax(dim=<span class="number">1</span>)  <span class="comment"># log_softmax layer</span></span><br><span class="line">softplus = nn.Softplus()  <span class="comment"># softplus layer</span></span><br></pre></td></tr></table></figure>

<h2 id="Customize-Stochastic-Variational-Inference-Object-SVI"><a href="#Customize-Stochastic-Variational-Inference-Object-SVI" class="headerlink" title="Customize Stochastic Variational Inference Object (SVI)"></a>Customize Stochastic Variational Inference Object (SVI)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> pyro</span><br><span class="line"><span class="keyword">from</span> pyro.distributions <span class="keyword">import</span> Normal, Categorical</span><br><span class="line"><span class="keyword">from</span> pyro.infer <span class="keyword">import</span> SVI, Trace_ELBO</span><br><span class="line"><span class="keyword">from</span> pyro.optim <span class="keyword">import</span> Adam</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Model</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">model</span>(<span class="params">x_data, y_data</span>):</span></span><br><span class="line">    fc1w_prior = Normal(loc=torch.zeros_like(net.fc1.weight), scale=torch.ones_like(net.fc1.weight))</span><br><span class="line">    fc1b_prior = Normal(loc=torch.zeros_like(net.fc1.bias), scale=torch.ones_like(net.fc1.bias))</span><br><span class="line">    fc2w_prior = Normal(loc=torch.zeros_like(net.fc2.weight), scale=torch.ones_like(net.fc2.weight))</span><br><span class="line">    fc2b_prior = Normal(loc=torch.zeros_like(net.fc2.bias), scale=torch.ones_like(net.fc2.bias))</span><br><span class="line"></span><br><span class="line">    priors = &#123;</span><br><span class="line">        <span class="string">&quot;fc1.weight&quot;</span>: fc1w_prior,</span><br><span class="line">        <span class="string">&quot;fc1.bias&quot;</span>: fc1b_prior,</span><br><span class="line">        <span class="string">&quot;fc2.weight&quot;</span>: fc2w_prior,</span><br><span class="line">        <span class="string">&quot;fc2.bias&quot;</span>: fc2b_prior,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># lift module parameters to random variables sampled from the priors</span></span><br><span class="line">    lifted_module = pyro.random_module(<span class="string">&quot;module&quot;</span>, net, priors)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sample a regressor (which also samples w and b)</span></span><br><span class="line">    lifted_reg_model = lifted_module()</span><br><span class="line">    lhat = log_softmax(lifted_reg_model(x_data))</span><br><span class="line">    pyro.sample(<span class="string">&quot;obs&quot;</span>, Categorical(logits=lhat), obs=y_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Guide</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guide</span>():</span></span><br><span class="line">    <span class="comment"># fc1 layer weight distribution priors</span></span><br><span class="line">    fc1w_mu = torch.randn_like(net.fc1.weight)</span><br><span class="line">    fc1w_sigma = torch.randn_like(net.fc1.weight)</span><br><span class="line">    fc1w_mu_param = pyro.param(<span class="string">&quot;fc1w_mu&quot;</span>, fc1w_mu)</span><br><span class="line">    fc1w_sigma_param = softplus(pyro.param(<span class="string">&quot;fc1w_sigma&quot;</span>, fc1w_sigma))</span><br><span class="line">    fc1w_prior = Normal(loc=fc1w_mu_param, scale=fc1w_sigma_param)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fc1 layer bias distribution priors</span></span><br><span class="line">    fc1b_mu = torch.randn_like(net.fc1.bias)</span><br><span class="line">    fc1b_sigma = torch.randn_like(net.fc1.bias)</span><br><span class="line">    fc1b_mu_param = pyro.param(<span class="string">&quot;fc1b_mu&quot;</span>, fc1b_mu)</span><br><span class="line">    fc1b_sigma_param = softplus(pyro.param(<span class="string">&quot;fc1b_sigma&quot;</span>, fc1b_sigma))</span><br><span class="line">    fc1b_prior = Normal(loc=fc1b_mu_param, scale=fc1b_sigma_param)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fc2 layer weight distribution priors</span></span><br><span class="line">    fc2w_mu = torch.randn_like(net.fc2.weight)</span><br><span class="line">    fc2w_sigma = torch.randn_like(net.fc2.weight)</span><br><span class="line">    fc2w_mu_param = pyro.param(<span class="string">&quot;fc2w_mu&quot;</span>, fc2w_mu)</span><br><span class="line">    fc2w_sigma_param = softplus(pyro.param(<span class="string">&quot;fc2w_sigma&quot;</span>, fc2w_sigma))</span><br><span class="line">    fc2w_prior = Normal(loc=fc2w_mu_param, scale=fc2w_sigma_param).independent(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fc2put layer bias distribution priors</span></span><br><span class="line">    fc2b_mu = torch.randn_like(net.fc2.bias)</span><br><span class="line">    fc2b_sigma = torch.randn_like(net.fc2.bias)</span><br><span class="line">    fc2b_mu_param = pyro.param(<span class="string">&quot;fc2b_mu&quot;</span>, fc2b_mu)</span><br><span class="line">    fc2b_sigma_param = softplus(pyro.param(<span class="string">&quot;fc2b_sigma&quot;</span>, fc2b_sigma))</span><br><span class="line">    fc2b_prior = Normal(loc=fc2b_mu_param, scale=fc2b_sigma_param)</span><br><span class="line"></span><br><span class="line">    priors = &#123;</span><br><span class="line">        <span class="string">&quot;fc1.weight&quot;</span>: fc1w_prior,</span><br><span class="line">        <span class="string">&quot;fc1.bias&quot;</span>: fc1b_prior,</span><br><span class="line">        <span class="string">&quot;fc2.weight&quot;</span>: fc2w_prior,</span><br><span class="line">        <span class="string">&quot;fc2.bias&quot;</span>: fc2b_prior,</span><br><span class="line">    &#125;</span><br><span class="line">    lifted_module = pyro.random_module(<span class="string">&quot;module&quot;</span>, net, priors)</span><br><span class="line">    <span class="keyword">return</span> lifted_module()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optimization</span></span><br><span class="line">optim = Adam(&#123;<span class="string">&quot;lr&quot;</span>: <span class="number">0.01</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SVI</span></span><br><span class="line">svi = SVI(model, guide, optim, loss=Trace_ELBO())</span><br></pre></td></tr></table></figure>

<h2 id="Train-and-Predict"><a href="#Train-and-Predict" class="headerlink" title="Train and Predict"></a>Train and Predict</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train</span></span><br><span class="line">num_iterations = <span class="number">5</span></span><br><span class="line">loss = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(num_iterations):</span><br><span class="line">    loss = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> batch_id, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        <span class="comment"># calculate the loss and take a gradient step</span></span><br><span class="line">        loss += svi.step(data[<span class="number">0</span>].view(-<span class="number">1</span>, <span class="number">28</span> * <span class="number">28</span>), data[<span class="number">1</span>])</span><br><span class="line">    normalizer_train = <span class="built_in">len</span>(train_loader.dataset)</span><br><span class="line">    total_epoch_loss_train = loss / normalizer_train</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Epoch &quot;</span>, j, <span class="string">&quot; Loss &quot;</span>, total_epoch_loss_train)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Predict</span></span><br><span class="line">num_samples = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span>(<span class="params">x</span>):</span></span><br><span class="line">    sampled_models = [guide() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_samples)]</span><br><span class="line">    yhats = [model(x).data <span class="keyword">for</span> model <span class="keyword">in</span> sampled_models]</span><br><span class="line">    mean = torch.mean(torch.stack(yhats), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> np.argmax(mean.numpy(), axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> colors</span><br><span class="line"></span><br><span class="line"><span class="comment"># Accuracy</span></span><br><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader):</span><br><span class="line">    images, labels = data</span><br><span class="line">    predicted = predict(images.view(-<span class="number">1</span>, <span class="number">28</span> * <span class="number">28</span>))</span><br><span class="line">    total += labels.size(<span class="number">0</span>)</span><br><span class="line">    correct += (torch.from_numpy(predicted) == labels).<span class="built_in">sum</span>().item()  <span class="comment"># convert array to tensor</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;accuracy: %d %%&quot;</span> % (<span class="number">100</span> * correct / total))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncertainty</span></span><br><span class="line">NUMS = (<span class="string">&quot;0&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">imshow</span>(<span class="params">img</span>):</span></span><br><span class="line">    img = img / <span class="number">2</span> + <span class="number">0.5</span>  <span class="comment"># unnormalize</span></span><br><span class="line">    npimg = img.numpy()</span><br><span class="line">    fig, ax = plt.subplots(figsize=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    ax.imshow(npimg, cmap=<span class="string">&quot;gray&quot;</span>, interpolation=<span class="string">&quot;nearest&quot;</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">num_samples = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">give_uncertainities</span>(<span class="params">x</span>):</span></span><br><span class="line">    sampled_models = [guide(<span class="literal">None</span>, <span class="literal">None</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_samples)]</span><br><span class="line">    yhats = [F.log_softmax(model(x.view(-<span class="number">1</span>, <span class="number">28</span> * <span class="number">28</span>)).data, <span class="number">1</span>).detach().numpy() <span class="keyword">for</span> model <span class="keyword">in</span> sampled_models]</span><br><span class="line">    <span class="keyword">return</span> np.asarray(yhats)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_batch</span>(<span class="params">images, labels, plot=<span class="literal">True</span></span>):</span></span><br><span class="line">    y = give_uncertainities(images)</span><br><span class="line">    predicted_for_images = <span class="number">0</span></span><br><span class="line">    correct_predictions = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(labels)):</span><br><span class="line">        <span class="keyword">if</span> plot:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Real: &quot;</span>, labels[i].item())</span><br><span class="line">            fig, axs = plt.subplots(<span class="number">1</span>, <span class="number">10</span>, sharey=<span class="literal">True</span>, figsize=(<span class="number">20</span>, <span class="number">2</span>))</span><br><span class="line">        all_digits_prob = []</span><br><span class="line">        highted_something = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(NUMS)):</span><br><span class="line">            highlight = <span class="literal">False</span></span><br><span class="line">            histo = []</span><br><span class="line">            histo_exp = []</span><br><span class="line">            <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(y.shape[<span class="number">0</span>]):</span><br><span class="line">                histo.append(y[z][i][j])</span><br><span class="line">                histo_exp.append(np.exp(y[z][i][j]))</span><br><span class="line"></span><br><span class="line">            prob = np.percentile(histo_exp, <span class="number">50</span>)  <span class="comment"># sampling median probability</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> prob &gt; <span class="number">0.2</span>:  <span class="comment"># select if network thinks this sample is 20% chance of this being a label</span></span><br><span class="line">                highlight = <span class="literal">True</span>  <span class="comment"># possibly an answer</span></span><br><span class="line">            all_digits_prob.append(prob)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> plot:</span><br><span class="line">                N, bins, patches = axs[j].hist(histo, bins=<span class="number">8</span>, color=<span class="string">&quot;lightgray&quot;</span>, lw=<span class="number">0</span>,</span><br><span class="line">                                               weights=np.ones(<span class="built_in">len</span>(histo)) / <span class="built_in">len</span>(histo), density=<span class="literal">False</span>)</span><br><span class="line">                axs[j].set_title(<span class="built_in">str</span>(j) + <span class="string">&quot; (&quot;</span> + <span class="built_in">str</span>(<span class="built_in">round</span>(prob, <span class="number">2</span>)) + <span class="string">&quot;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> highlight:</span><br><span class="line">                highted_something = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> plot:</span><br><span class="line">                    <span class="comment"># We&#x27;ll color code by height, but you could use any scalar</span></span><br><span class="line">                    fracs = N / N.<span class="built_in">max</span>()</span><br><span class="line">                    <span class="comment"># we need to normalize the data to 0..1 for the full range of the colormap</span></span><br><span class="line">                    norm = colors.Normalize(fracs.<span class="built_in">min</span>(), fracs.<span class="built_in">max</span>())</span><br><span class="line">                    <span class="comment"># Now, we&#x27;ll loop through our objects and set the color of each accordingly</span></span><br><span class="line">                    <span class="keyword">for</span> thisfrac, thispatch <span class="keyword">in</span> <span class="built_in">zip</span>(fracs, patches):</span><br><span class="line">                        color = plt.cm.viridis(norm(thisfrac))</span><br><span class="line">                        thispatch.set_facecolor(color)</span><br><span class="line">        <span class="keyword">if</span> plot:</span><br><span class="line">            plt.show()</span><br><span class="line"></span><br><span class="line">        predicted = np.argmax(all_digits_prob)</span><br><span class="line">        <span class="keyword">if</span> highted_something:</span><br><span class="line">            predicted_for_images += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> labels[i].item() == predicted:</span><br><span class="line">                <span class="keyword">if</span> plot:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Correct&quot;</span>)</span><br><span class="line">                correct_predictions += <span class="number">1.0</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> (plot):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;Incorrect :()&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> (plot):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Undecided.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> plot:</span><br><span class="line">            imshow(images[i].squeeze())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> plot:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Summary&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Total images: &quot;</span>, <span class="built_in">len</span>(labels))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Predicted for: &quot;</span>, predicted_for_images)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Accuracy when predicted: &quot;</span>, correct_predictions / predicted_for_images)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(labels), correct_predictions, predicted_for_images</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prediction when network can decide not to predict</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Prediction when network can refuse&#x27;</span>)</span><br><span class="line">correct = <span class="number">0</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line">total_predicted_for = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(test_loader):</span><br><span class="line">    images, labels = data</span><br><span class="line">    total_minibatch, correct_minibatch, predictions_minibatch = test_batch(images, labels, plot=<span class="literal">False</span>)</span><br><span class="line">    total += total_minibatch</span><br><span class="line">    correct += correct_minibatch</span><br><span class="line">    total_predicted_for += predictions_minibatch</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Total images: &quot;</span>, total)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Skipped: &quot;</span>, total - total_predicted_for)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Accuracy when made predictions: %d %%&quot;</span> % (<span class="number">100</span> * correct / total_predicted_for))</span><br><span class="line"></span><br><span class="line"><span class="comment"># preparing for evaluation</span></span><br><span class="line">dataiter = <span class="built_in">iter</span>(test_loader)</span><br><span class="line">images, labels = dataiter.<span class="built_in">next</span>()</span><br><span class="line">test_batch(images[:<span class="number">100</span>], labels[:<span class="number">100</span>])</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/Python/">Python</a></li>
         
          <li><a href="/Plant/">Plant</a></li>
         
          <li><a href="/Others/">Others</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Related-Libraries"><span class="toc-number">1.</span> <span class="toc-text">Related Libraries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Load-Data-Set"><span class="toc-number">2.</span> <span class="toc-text">Load Data Set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Define-and-Construct-the-Network"><span class="toc-number">3.</span> <span class="toc-text">Define and Construct the Network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Customize-Stochastic-Variational-Inference-Object-SVI"><span class="toc-number">4.</span> <span class="toc-text">Customize Stochastic Variational Inference Object (SVI)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Train-and-Predict"><span class="toc-number">5.</span> <span class="toc-text">Train and Predict</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Evaluation"><span class="toc-number">6.</span> <span class="toc-text">Evaluation</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://xli1110.github.io/2021/11/30/BNN/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://xli1110.github.io/2021/11/30/BNN/&text=BNN"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://xli1110.github.io/2021/11/30/BNN/&is_video=false&description=BNN"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BNN&body=Check out this article: https://xli1110.github.io/2021/11/30/BNN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://xli1110.github.io/2021/11/30/BNN/&title=BNN"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://xli1110.github.io/2021/11/30/BNN/&name=BNN&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://xli1110.github.io/2021/11/30/BNN/&t=BNN"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    xli
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/Python/">Python</a></li>
         
          <li><a href="/Plant/">Plant</a></li>
         
          <li><a href="/Others/">Others</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
